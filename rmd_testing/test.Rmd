---
title: "R Markdown test rmd"
author: '*Compiled on `r date()` by `r Sys.info()["user"]`*'
output:
  html_document:
    highlight: haddock
    includes:
      in_header: ~/github/ohibc/src/templates/ohibc_hdr1.html
    number_sections: yes
    theme: cerulean
    toc: yes
  html_notebook: null
  pdf_document:
    toc: yes
---

-----

```{r setup, echo = TRUE, message = FALSE, warning = FALSE}
dir_git <- '~/github/provRmd'
library(dplyr)
library(readr)
library(stringr)

dir_test <- file.path(dir_git, 'rmd_testing')

### set up provenance tracking for this script:
# document(); install()
library(provRmd)
prov_setup()### initializes prov_track and loads functions

```

# read a table; capture prov info

```{r read global species list, echo = TRUE, message = FALSE, warning = FALSE}
table1_file <- file.path(dir_test, 'table1.csv')
table1      <- read.csv(table1_file, stringsAsFactors = FALSE)

table2_file <- file.path(dir_test, 'table2.csv')
write.csv(table1, table2_file)

table3_file <- file.path(dir_test, 'table3.csv')
write.csv(table1, table3_file)

```

```{r sourcing a file, message = FALSE, echo = TRUE}
source(file.path(dir_test, 'test_source.R'))

```

```{r display table, echo = TRUE}
DT::datatable(table1,   ### does not display system and session info
              caption  = 'this is a sample table:',              
              rownames = FALSE,
              class    = 'stripe hover compact',
              options  = list(dom = 'tp'))
```

-----

# The next section (below the divider) is the footer, knitted as a child

The code for the R code chunk header looks like this:

`{r child = system.file('footer/prov_ftr1.Rmd', package = 'provRmd')}`

Note that it is executed as if it were just part of this main document; it numbers the section ("Provenance") as a continuation of the numbering, and the variables are evaluated in the environment of the main document.

``` {r, results = 'asis'}
# footer_fun <- function() {
#   y <- system.file('footer/prov_ftr3.Rmd', package = 'provRmd'); message('footer 3 exists? ', file.exists(y))
#   x <- knitr::knit_child(y)
#   return(x)
# }

# footer_fun <- function(include_summary   = TRUE, 
#                        include_flowchart = TRUE, 
#                        include_table     = TRUE,
#                        plot_dir = 'TD') {
#   cat('# Provenance\n')
#   cat(list.files(system.file('footer', package = 'provRmd')), '\n')
# 
#   suppressMessages(suppressWarnings({
#     script_prov_out_df <- script_prov(.prov_parent_script_file) 
#   }))
# 
#   if(include_summary) {
#     cat(sprintf('- _Run ID: %s (%s); run tag: "%s"_\n',
#                 script_prov_out_df$run_id, 
#                 script_prov_out_df$run_hash %>% str_sub(1, 7),
#                 script_prov_out_df$run_tag))
#     cat(sprintf('- _Run elapsed time: %s seconds; run memory usage: %s MB_\n',
#                 script_prov_out_df$elapsed_time,
#                 script_prov_out_df$memory_use))
#     cat(sprintf('- _System info: _\n    - _%s_\n', script_prov_out_df$msg_sys))
#     cat(sprintf('    - _%s_\n', script_prov_out_df$msg_ses))
#     cat(sprintf('    - _%s_\n', script_prov_out_df$msg_base_pkgs))
#     cat(sprintf('    - _%s_\n', script_prov_out_df$msg_att_pkgs))
#   }
#   
#   if(include_flowchart) {
#     prov_dgr_out <- plot_prov(.script_track, plot_dir = plot_dir)
# 
#     svg <- DiagrammeRsvg::export_svg(DiagrammeR::render_graph(prov_dgr_out))
#     print(htmltools::HTML(svg))
#   }
#   
#   if(include_table) {
#     cat('\n')
#     prov_tbl <- .script_track %>%
#       dplyr::mutate(commit_url  = str_replace(commit_url, 'Previous commit: ', ''),
#              commit_url  = ifelse(commit_url == 'no version control info found', NA, commit_url),
#              commit_hash = ifelse(is.na(commit_url), NA,
#                                  sprintf('[%s](%s)', str_sub(commit_url, -40, -34), commit_url)),
#              commit_hash_short = ifelse(is.na(commit_url), NA,
#                                  sprintf('%s', str_sub(commit_url, -40, -34))))
#     
#     run_id   <- first(prov_tbl$run_id)
#     run_hash <- first(prov_tbl$run_hash) %>% str_sub(1, 7)
#     run_tag  <- first(prov_tbl$run_tag)
#     run_date <- first(prov_tbl$run_date)
#     
#     prov_tbl1 <- prov_tbl %>%
#       dplyr::mutate(file_name = basename(file_loc),
#              file_dir  = dirname(file_loc) %>% str_replace(path.expand('~'), '~')) %>%
#       dplyr::select(sequence, file_name, parent_chunk,
#                     file_dir, filetype, 
#                     uncomm_chgs = uncommitted_changes, commit_hash_short)
#     
#     DT::datatable(prov_tbl1 %>% 
#                     dplyr::arrange(sequence, desc(filetype), file_name),
#                     caption = sprintf('Provenance summary for run %s (%s): %s (%s)', 
#                                       run_id, run_hash, run_tag, run_date),             
#                   rownames = FALSE,
#                   class = 'stripe hover compact',
#                   options  = list(dom = 'tp'))
#   }
# }

# footer_fun(include_table = F)

prov_wrapup()

```
